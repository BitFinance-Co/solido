(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[288],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return u},kt:function(){return c}});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=p(a),c=i,k=d["".concat(s,".").concat(c)]||d[c]||m[c]||r;return a?n.createElement(k,l(l({ref:t},u),{},{components:a})):n.createElement(k,l({ref:t},u))}));function c(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,l=new Array(r);l[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:i,l[1]=o;for(var p=2;p<r;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},8946:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return l},metadata:function(){return o},toc:function(){return s},default:function(){return u}});var n=a(2122),i=a(9756),r=(a(7294),a(3905)),l={},o={unversionedId:"WIP/Fees/fees-management",id:"WIP/Fees/fees-management",isDocsHomePage:!1,title:"Fees Management",description:"Fee Management",source:"@site/docs/WIP/Fees/fees-management.md",sourceDirName:"WIP/Fees",slug:"/WIP/Fees/fees-management",permalink:"/solido/docs/WIP/Fees/fees-management",version:"current",frontMatter:{}},s=[{value:"Fee Management",id:"fee-management",children:[{value:"What do we want to achieve?",id:"what-do-we-want-to-achieve",children:[]},{value:"How do we achieve this?",id:"how-do-we-achieve-this",children:[]},{value:"Context : Stake Pool Program",id:"context--stake-pool-program",children:[]},{value:"Context : Lido Program",id:"context--lido-program",children:[]},{value:"DistributeFees : In Detail",id:"distributefees--in-detail",children:[]},{value:"What needs to be called periodically?",id:"what-needs-to-be-called-periodically",children:[]},{value:"WIP Notes",id:"wip-notes",children:[]}]}],p={toc:s};function u(e){var t=e.components,a=(0,i.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"fee-management"},"Fee Management"),(0,r.kt)("p",null,"Status - As of 6 May 2021"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"First Draft. To be discussed with Fynn.")),(0,r.kt)("h3",{id:"what-do-we-want-to-achieve"},"What do we want to achieve?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"We want to take X% of the staking Fees as fees and distribute them across Lido stakeholders.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"X is set by Lido Governance (default : 10%)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Who are these stakeholders and what is the distribution pattern?"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Insurance Fund : a% (of the X%)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Treasury Fund : b%")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Chorus One Fund : c%")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Validator Fund : d% (Further, this is distributed equally across the current list of validators)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"(a+b+c+d) = 100%")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"TODO : Check with Felix about Chorus One")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Following from the design in Lido for ETH, ideally the fee would be distributed across stakeholders  in the form of LSOL tokens."))),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"how-do-we-achieve-this"},"How do we achieve this?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Jon has added a generic ",(0,r.kt)("inlineCode",{parentName:"p"},"Fee Cut on Fees")," Mechanism to the Stake Pool Program"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"the mechanism ensures fee goes to a fee beneficiary : in the form of stake pool tokens."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"we need to make sure this mechanism is configured correctly in our deployment."),(0,r.kt)("li",{parentName:"ul"},"eg. Fee Cut, Beneficiary"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Additionally, we need functionality to distribute these fees across all stakeholders in the form of LSOL tokens.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"This would require additions to the Lido Program"))),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"context--stake-pool-program"},"Context : Stake Pool Program"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"In the Stake Pool program, one can set the Fee percentage on initialisation - with the relevant parameter being ",(0,r.kt)("inlineCode",{parentName:"p"},"stake_pool.fee"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Also, on initialisation, one can set the Fee Beneficiary : ",(0,r.kt)("inlineCode",{parentName:"p"},"stake_pool.manager_fee_account"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Everytime ",(0,r.kt)("inlineCode",{parentName:"p"},"UpdateStakePoolBalance")," instruction is called, the latest staking Fees are calculated and ",(0,r.kt)("inlineCode",{parentName:"p"},"Fee Percentage")," of these new Fees go to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Fee Beneficiary")," in the form of Stake Pool Tokens")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Additionally, manager can update these params post-deployment of the Stake Pool."))),(0,r.kt)("h4",{id:"how-do-we-configure-this-correctly-to-achieve-our-objective"},"How do we configure this correctly to achieve our objective?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Set the Fee percentage as X (numerator, denominator) on initialisation (highly likely : the default value of X will be 10%)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Set the Fee Beneficiary to be the ",(0,r.kt)("inlineCode",{parentName:"p"},"Fee Authority PDA of the Lido Program"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"We want the MultiSig Governance to be able to update these two params")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"In general, we will set ",(0,r.kt)("inlineCode",{parentName:"p"},"Manager of Stake Pool")," to be our MultiSig Governance program - so this should be taken care of."))),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"context--lido-program"},"Context : Lido Program"),(0,r.kt)("h4",{id:"what-additions-do-we-need-in-the-lido-program"},"What additions do we need in the Lido Program?"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a Fee Authority (PDA) in the Lido Program"),(0,r.kt)("li",{parentName:"ol"},"Set it as Fee Beneficiary in the Stake Pool Program"),(0,r.kt)("li",{parentName:"ol"},"Periodically*, this Fee Authority will receive fees in the form of Stake Pool Tokens."),(0,r.kt)("li",{parentName:"ol"},"The intent is to distribute this fees across relevant Lido stakeholders in the form of LSOL.")),(0,r.kt)("h4",{id:"configuration-params-required-in-lido-program-can-be-changed-by-governance"},"Configuration Params required in Lido Program (can be changed by governance)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Account Information (aka Recipient Addresses) For"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"InsuranceFund : ",(0,r.kt)("inlineCode",{parentName:"li"},"InsuranceFundAddress")),(0,r.kt)("li",{parentName:"ul"},"TreasuryFund : ",(0,r.kt)("inlineCode",{parentName:"li"},"TreasuryFundAddress")),(0,r.kt)("li",{parentName:"ul"},"ChorusOneFund : ",(0,r.kt)("inlineCode",{parentName:"li"},"ChorusOneFundAddress")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Params (Save in Lido State. Editable by Governance. With Defaults)"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"InsuranceFeeNumerator  ",(0,r.kt)("inlineCode",{parentName:"p"},"ifN"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"TreasuryFeeNumerator  \t",(0,r.kt)("inlineCode",{parentName:"p"},"tfN"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ChorusFeeNumerator    \t",(0,r.kt)("inlineCode",{parentName:"p"},"cfN"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ValidatorFeeNumerator \t",(0,r.kt)("inlineCode",{parentName:"p"},"vfN"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Denominator - ",(0,r.kt)("inlineCode",{parentName:"p"},"fDR"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"As discussed, let's keep a common Denominator and store it in ",(0,r.kt)("inlineCode",{parentName:"p"},"DR"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The 4 fee params store the numerators for the 4 fees respectively")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Validity Check : ifN + tfN + cfN + vfN == fDR`"))))),(0,r.kt)("h4",{id:"instructions-required-in-lido-program"},"Instructions required in Lido Program"),(0,r.kt)("p",null,"We need the following instructions (and corresponding ",(0,r.kt)("inlineCode",{parentName:"p"},"process_*")," functions)"),(0,r.kt)("h4",{id:"a-instructions-to-update-above-parameters"},"A. Instructions to update above parameters"),(0,r.kt)("h4",{id:"b-instructions-to-distribute-fees-as-lsol-tokens"},"B. Instructions to distribute fees (as LSOL tokens)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"My understanding here is - because of Solana transaction limits - we will need 2 instructions here.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"DistributeFees")," : that calculates fees for each stakeholder (in LSOL) and marks it in their name."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"This will require maintaining a data structure - effectively a map from ",(0,r.kt)("inlineCode",{parentName:"li"},"Recipient")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"LSOL Amount they are entitled to"),".")))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"WithdrawFees")," : with this, anyone can withdraw the LSOL fees  to a recipient (upto the amount the recipient are entitled to)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"TODO : Confirm with Fynn : Both DistributeFees and WithdrawFees can't happen in one step as number of recipients is 3+V (and we don't want to bound V to ",(0,r.kt)("inlineCode",{parentName:"p"},"< 10")," for sure)"))),(0,r.kt)("h4",{id:"distributefees"},"DistributeFees"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"can be called by a bot every epoch (+ ideally called atleast once every epoch)"),(0,r.kt)("li",{parentName:"ul"},"invokes the transfer of Stake Pool tokens held by Fee Authority to Deposit Authority, in lieu of which, LSOL are minted to the Fee Authority so it can distribute it across fee stakeholders"),(0,r.kt)("li",{parentName:"ul"},"updates the list of who is entitled to withdraw how many LSOL as fees (list contains Insurance, Treasury, Chorus One and all validators as recipients)")),(0,r.kt)("h4",{id:"withdrawfeesrecipient-amount"},"WithdrawFees(recipient, amount)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"With the WithdrawFees function, claimants can withdraw the LSOL they are entitled to in the map maintained by the Fee Authority"),(0,r.kt)("li",{parentName:"ul"},"This can be called by anyone, not just the recipient"),(0,r.kt)("li",{parentName:"ul"},"Function will try to transfer LSOL to the recipient specified if they are entitled to them as part of the list maintained by DistributeFees.")),(0,r.kt)("h3",{id:"distributefees--in-detail"},"DistributeFees : In Detail"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Starting State : Fee Authority has received ",(0,r.kt)("inlineCode",{parentName:"p"},"t")," stake pool tokens (as fee beneficiary of the Stake Pool Program)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Transfer these ",(0,r.kt)("inlineCode",{parentName:"li"},"t stake pool tokens")," from  Fee Authority (FA) to Deposit Authority (DA)"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:2},(0,r.kt)("li",{parentName:"ol"},"Mint new LSOL to the Fee Authority with the calculation",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"`New LSOL Minted to FA  = Total LSOL * (t / Stake Pool Tokens held by Deposit Authority before Transfer of t)"),(0,r.kt)("li",{parentName:"ul"},"Update ",(0,r.kt)("inlineCode",{parentName:"li"},"Total LSOL")))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:4},(0,r.kt)("li",{parentName:"ol"},"For the LSOL Fees, we maintain a map of which stakeholder will get how much LSOL")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Update the map to reflect who all are entitled to these newly minted LSOL (and how much)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Insurance"),(0,r.kt)("li",{parentName:"ul"},"Treasury"),(0,r.kt)("li",{parentName:"ul"},"Chorus One"),(0,r.kt)("li",{parentName:"ul"},"Validators - Refer latest list in Stake Pool Program and distribute across the latest list of validators",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"TODO : Check with Fynn about map datastructure. Is map DS supported? Storage limits? This might bound number of Valdiators (~100ish?)")))))))),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"what-needs-to-be-called-periodically"},"What needs to be called periodically?"),(0,r.kt)("p",null,"A. PoolBalanceUpdate of Stake Pool Program  (once every epoch by a bot)\nB. DistributeFees of Lido Program  (once every epoch by a bot)\nC. WithdrawFees(recipient, amount) - possibly the bot can call this periodically for all 3+V stakeholders - to keep the storage light?"),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"wip-notes"},"WIP Notes"),(0,r.kt)("p",null,"Following notes are quite WIP-ish."),(0,r.kt)("p",null,"Dependents"),(0,r.kt)("p",null,"B. Add / Remove Validator"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Note : If validator list is updated in an epoch, it's best to check if ",(0,r.kt)("inlineCode",{parentName:"li"},"PoolBalanceUpdate")," (stake pool program) and ",(0,r.kt)("inlineCode",{parentName:"li"},"DistributeFees")," (lido program) have occurred in this epoch.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The former has a check flag in Stake Pool Program"),(0,r.kt)("li",{parentName:"ul"},"The latter can be checked by ",(0,r.kt)("inlineCode",{parentName:"li"},"Stake Pool Token Balance of Fee Authority === 0")),(0,r.kt)("li",{parentName:"ul"},"We need (Former && Latter)")))),(0,r.kt)("hr",null),(0,r.kt)("p",null,"TODO : Check with Vasily"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"How do we address the distribution of Fees across validators - in the case where they have unequal non-zero commission rates set already?")),(0,r.kt)("hr",null))}u.isMDXComponent=!0}}]);